### Системы координат

Переход из 'старой' системы координат ${O, e1, e2, e3}$ в 'новую' ${O', e1', e2', e3'}$$ описывается формулой:

$$ 
\begin{pmatrix}
x \\ 
y \\ 
z \\
\end{pmatrix}
=
\begin{pmatrix}
a_{11} & a_{12} & a_{13} & x_0 \\
a_{21} & a_{22} & a_{23} & y_0 \\
a_{31} & a_{32} & a_{33} & z_0 \\
\end{pmatrix}
\cdot
\begin{pmatrix}
x' \\ 
y' \\ 
z' \\
\end{pmatrix}
+
\begin{pmatrix}
x' \\ 
y' \\ 
z' \\
\end{pmatrix}
$$

$(x, y, z)$ - координаты точки в старой системе; $(x', y', z')$ - координаты точки в новой системе; коэффициенты $a_{ij}$ получаются из разложения векторов нового базиса по старому, например:

$$ e1' = a_{11}e1 + a_{12}e2 + a_{13}e3$$

Преобразовав, можно получить следующую форму:

$$ 
\begin{pmatrix}
x \\ 
y \\ 
z \\
1
\end{pmatrix}
=
\begin{pmatrix}
a_{11} & a_{12} & a_{13} & x_0 \\
a_{21} & a_{22} & a_{23} & y_0 \\
a_{31} & a_{32} & a_{33} & z_0 \\
0 & 0 & 0 & 1
\end{pmatrix}
\cdot
\begin{pmatrix}
x' \\ 
y' \\ 
z' \\
1
\end{pmatrix}
$$

Здесь хорошо описано про системы координат в DICOM.
Условимся, что куб имеет следующую локальную систему координат:
- Начало координат $O'$ задается атрибутом `ImagePositionPatient`;
- Вектора $i, j$ задаются атрибутом `ImageOrientationPatient` соответственно;
- Вектор $k$ вычисляется как $i \times j$ (векторное произведение).
- Вектора $i, j, k$ должны быть нормализованы.

Получаем

$$ 
\begin{pmatrix}
x \\ 
y \\ 
z \\
1
\end{pmatrix}
=
\begin{pmatrix}
a_{11} & a_{12} & a_{13} & x_0 \\
a_{21} & a_{22} & a_{23} & y_0 \\
a_{31} & a_{32} & a_{33} & z_0 \\
0 & 0 & 0 & 1
\end{pmatrix}
\cdot
\begin{pmatrix}
x' \\ 
y' \\ 
z' \\
1
\end{pmatrix}
$$